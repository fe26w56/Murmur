# Murmur - ドキュメントレビュー報告書

> レビュー実施日: 2026-02-15
> 対応完了日: 2026-02-15
> 対象: 01-requirements.md / 02-api-research.md / 03-system-design.md
> レビュー観点: 要件の網羅性、API調査の十分性、設計の妥当性、考慮漏れ
>
> **対応ステータス**: Critical 6件中 6件対応済み / Major 24件中 主要項目対応済み

---

## 総合評価

| 対象 | 評価 | 一言 |
|------|------|------|
| 要件定義書 | **B+** | 差別化が明確で実装着手できるレベル。法的リスクと実利用環境の制約が未検討 |
| API調査レポート | **B+** | 用途に即した比較で網羅的。一部数値の正確性と追加調査領域あり |
| 設計書 | **B** | 翻訳パイプラインが秀逸。ただし **VercelのWebSocket非対応** が致命的 |

---

## Critical（対応必須）

### 1. VercelでWebSocketが使えない [設計]

**設計の根幹に関わる最大の問題。**

設計書では `/api/transcribe` をWebSocket Proxyとして定義しているが、**VercelのServerless FunctionsはWebSocketをサポートしていない**。Fluid Computeを有効にしても不可。

#### 対策案

| 案 | 概要 | メリット | デメリット |
|----|------|---------|-----------|
| **A（推奨）** | クライアント→Deepgram直接WebSocket + 翻訳は個別POST→SSE | シンプル、Vercelのまま | Deepgram APIキーの露出対策が必要（一時トークンで解決可能） |
| B | Fly.io等に別途WebSocketサーバーをデプロイ | サーバー側で状態管理可能 | インフラ2つで運用複雑化 |
| C | Rivet for Vercel Functions を採用 | Vercel上で完結 | 新しいサービスで実績が限定的 |

**案Aの場合のアーキテクチャ修正:**
- クライアントがDeepgramに直接接続（一時トークンをVercel APIで発行）
- 文字起こし結果はクライアント側で受信
- 翻訳はutteranceごとに独立したHTTPリクエスト（POST→SSE）
- UtteranceBuffer・スライディングウィンドウの状態管理はクライアント側（Zustand）

### 2. Vercel Serverless Functionのタイムアウト制約 [設計]

Vercel Proプランでも最大800秒（≒13分）。ライブ翻訳セッション（30分〜1時間）に不十分。

→ 案Aを採用すれば、翻訳リクエストが短い独立したHTTP往復になるため回避可能。

### 3. Gemini Context Cachingの最小トークン数制約 [設計]

Gemini 3 Flashのcontext cachingは**最小1,024トークン**が必要。設計書のLayer 3（~500トークン）では足りない。

→ システムプロンプト全体 + Layer 3の全要素を含めて1,024トークン以上にするか、Layer 2（~5K）をキャッシュ対象に含める設計に修正。

### 4. 著作権・法的リスクの検討が不十分 [要件]

ディズニーの台本をプリセットテンプレートとして**有料商用アプリに同梱**することの法的リスクが未分析。

- ファンサイトの書き起こしは二次的著作物であり、商用利用はリスク大
- ディズニーは知的財産保護に極めて積極的
- 劇場内での音声キャプチャは施設利用規約に違反する可能性
- Firecrawlでのスクレイピングと各サイトのrobots.txt/利用規約の整合性

→ 法的リスクを「高」に引き上げ、著作権弁護士レビュー計画・免責条項設計・DMCA対応フローを記載すべき。テンプレートの内容も「台本全文」→「用語集+概要」への制限を検討。

### 5. オフライン/低帯域環境への対策がない [要件]

テーマパーク（地下/建物内）・劇場でのセルラー回線は不安定。

- PCM 16bit 16kHz = 約256kbpsの上り帯域が必要
- 海外ローミング時の通信速度制限
- 通信断が頻発する環境での再接続中のデータロス

→ 非機能要件に「ネットワーク要件」セクション追加。最低帯域、Opus/AACコーデックでの帯域削減、オフライン時UI挙動を定義。

### 6. 音声キャプチャの技術的制約が未記載 [要件]

- **iOSバックグラウンド制限**: 画面ロック/アプリ切替で`getUserMedia`停止。劇場で1-2時間使うなら画面常時ON必須
- **Wake Lock API**: 画面自動ロック防止が必要だがブラウザ対応状況の記載なし
- **バッテリー消費**: WebSocket常時接続 + マイク + 画面ON = 著しい消耗。見積もりなし
- **マイクの指向性**: 内蔵マイクは近距離用。スピーカーから数メートル離れた音声には不向き

---

## Major（品質向上のために対応推奨）

### 要件定義書

| # | 指摘 | 詳細 |
|---|------|------|
| M1 | ユーザーストーリーの不在 | ペルソナと行動フロー（旅行前・当日・体験中・体験後）を具体的に記載すべき |
| M2 | オンボーディング未設計 | 初回チュートリアル、マイク権限取得タイミング、おすすめテンプレート表示 |
| M3 | セッション中の操作性不足 | 一時停止/再開、コンテキスト動的切替、音量レベル表示、翻訳信頼度UI |
| M4 | プライバシーポリシー不在 | 音声データ保持期間、GDPR対応、データ削除要求への対応 |
| M5 | アクセシビリティ要件欠落 | WCAG準拠レベル、最小フォントサイズ定義、タップ領域サイズ |
| M6 | スケーラビリティ目標なし | 同時接続数想定、Deepgram同時接続上限、将来のスケーリング戦略 |
| M7 | テスト要件なし | 音声認識ベンチマーク方法、翻訳品質評価基準、フィールドテスト計画 |
| M8 | 決済手段未定義 | 決済プロバイダ、利用時間計測方法、無料枠超過時挙動 |
| M9 | MVPとの不整合 | 認証がMVPリストにない / ダークモードがPhase 3だが劇場は主要ユースケース / PWAが非機能要件にあるがPhase 3 |

### API調査レポート

| # | 指摘 | 詳細 |
|---|------|------|
| M10 | AssemblyAI WER過小評価 | WER 14.5%は古いデータ。現行Universal-3 Proはプロンプトベースカスタマイズ対応でMurmurとの親和性が高い |
| M11 | Speechmaticsが未調査 | EN→JPリアルタイム翻訳を単一APIで提供。Gemini Live APIと同様にPhase 2候補として検討すべき |
| M12 | Soniox v3の過小評価 | 英語WER 6.5%でDeepgramと同等、価格1/4。騒音環境ベンチマークでの比較データが必要 |
| M13 | EN→JP翻訳品質の定量比較なし | SimpleQAは事実性指標であり翻訳品質の直接測定ではない。実際の台本テキストでの比較テストが必要 |
| M14 | コスト試算の前提不明確 | 翻訳リクエスト頻度、コンテキストキャッシュ効果、スライディングウィンドウの累積トークン数が未考慮 |
| M15 | WMT24実績の帰属誤り | WMT24で9言語ペア1位はClaude 3.5 Sonnet。4.5 Sonnetでの翻訳品質は別途検証必要 |
| M16 | Web Speech APIフォールバック未検証 | iOS Safariでの対応状況、騒音精度、Deepgramとの互換性が未調査 |

### 設計書

| # | 指摘 | 詳細 |
|---|------|------|
| M17 | transcriptsのINSERTポリシーが甘い | `WITH CHECK (true)` は全ユーザーが任意セッションに挿入可能。sessions.user_idのチェックが必要 |
| M18 | profilesにINSERTポリシーがない | Auth後のprofile作成が失敗する。トリガー自動作成かINSERTポリシー追加が必要 |
| M19 | セッション状態管理の再設計 | 案A採用時、UtteranceBuffer/スライディングウィンドウはクライアント側（Zustand）に移動 |
| M20 | 翻訳の表示順序保証がない | 並行翻訳時にUtterance 4が3より先に完了すると字幕が逆転。シーケンス番号制御が必要 |
| M21 | コスト試算が過小 | 毎リクエストにコンテキスト(~500)+履歴(~200)が付与される。200発話/時なら入力146Kトークンで試算の5倍 |
| M22 | 音声データの保存・破棄ポリシー未設計 | 要件にある「暗号化保存」に対応する設計がない。Deepgramへのデータ保持設定も未確認 |
| M23 | 利用時間追跡の仕組みがない | 料金プランに時間制限があるが、計測・制限の実装設計なし |
| M24 | 監視・ロギングの設計不足 | 翻訳レイテンシ計測、認識精度モニタリング、エラー率追跡など運用監視が未設計 |

---

## Minor（余裕があれば対応）

| # | 指摘 | 対象 |
|---|------|------|
| m1 | 「グロッサリー」と「用語集」が混在 | 要件 |
| m2 | 「録音」と「音声キャプチャ」の用語混同 | 要件 |
| m3 | プリセットテンプレートの維持管理フロー未記載 | 要件 |
| m4 | エクスポート形式（SRT字幕？タイムスタンプ付き？）が未定義 | 要件 |
| m5 | MVPの言語ペアがEN→JP固定であることが明記されていない | 要件 |
| m6 | Phase 1で3ティア全部なのかpremiumはPhase 2以降か曖昧 | 要件 |
| m7 | 複数デバイス同時利用時の挙動未定義 | 要件 |
| m8 | ElevenLabs WER欄が精度（93.5%）とWERで不統一 | API調査 |
| m9 | OpenAI Realtime APIの概算時間単価がない | API調査 |
| m10 | Qwen-MT Turboの地理的制約（レイテンシ、データ主権）未記載 | API調査 |
| m11 | Firecrawlの代替（Jina Reader API等）未比較 | API調査 |
| m12 | context_templatesの管理者向けINSERT/UPDATE運用未設計 | 設計 |
| m13 | contextsテーブルのtypeカラムにインデックスなし | 設計 |
| m14 | 5.2と5.5のプロンプト使い分け条件が不明確 | 設計 |
| m15 | 翻訳先言語が日本語にハードコード（glossaryのjaフィールド等）、多言語拡張時の修正範囲大 | 設計 |
| m16 | コンテキスト調査の部分成功ステータスがない（errorのみ） | 設計 |

---

## 欠落している要件・設計の一覧

### 要件定義書に追加すべき項目

1. ネットワーク要件（最低帯域、海外ローミング考慮）
2. バッテリー消費の見積もりと省電力設計
3. Wake Lock API（画面ロック防止）
4. 外部マイク対応（ラベリアマイク、Bluetoothイヤホン）
5. ユーザーストーリー/ペルソナ
6. オンボーディングフロー
7. 利用規約・プライバシーポリシー方針
8. 著作権対応方針（法的レビュー計画）
9. 決済・サブスクリプション管理
10. テスト戦略（ベンチマーク、フィールドテスト）
11. スケーラビリティ目標（同時接続数）
12. アクセシビリティ要件
13. ユーザー設定の永続化
14. 利用時間残量の通知・制限挙動
15. 施設内利用マナーガイドライン（輝度自動調整等）

### API調査で追加すべき項目

1. AssemblyAI Universal-3 Pro の再評価
2. Speechmatics の統合音声翻訳APIの評価
3. Soniox v3 vs Deepgram Nova-3 の騒音環境ベンチマーク
4. EN→JP翻訳品質の定量比較（実台本テキストで）
5. Web Speech API のiOS Safari対応検証
6. 各APIのSLA・レート制限の調査
7. 月額$9.99の損益分岐点分析（インフラコスト含む）
8. DeepL Voice API 料金公開後の再評価

### 設計書に追加すべき項目

1. **アーキテクチャの修正**（WebSocket問題の解決）
2. クライアント側セッション状態管理設計
3. 音声データの保存・破棄ポリシー
4. 利用時間追跡・課金制御の実装設計
5. 翻訳リクエストの順序制御
6. ブラウザバックグラウンド制限への対応
7. 監視・ロギング設計
8. テスト戦略（モック音声データの投入方法等）
9. RLSポリシーの修正（transcripts INSERT、profiles INSERT）
10. Context Cachingの最小トークン要件への対応

---

## 対応優先度マトリクス

```
          緊急度 高 ←─────────────────────────→ 緊急度 低
影響度 高  │ C1 Vercel WebSocket     │ C4 著作権リスク           │
          │ C2 タイムアウト制約      │ M1 ユーザーストーリー     │
          │ C3 Context Cache制約    │ M6 スケーラビリティ目標   │
          │ M17 RLSポリシー修正     │ M7 テスト戦略             │
          │ M19 状態管理再設計       │ M11 Speechmatics調査     │
          ├─────────────────────────┼────────────────────────────┤
影響度 低  │ C5 ネットワーク要件     │ m1-m16 各種軽微な指摘     │
          │ C6 音声キャプチャ制約   │                            │
          │ M21 コスト試算修正      │                            │
          │ M20 翻訳順序制御        │                            │
```

---

## 総括

Murmurのドキュメント群は、プロダクトのコア価値（事前コンテキスト登録による翻訳精度向上）が一貫しており、技術選定の根拠も充実している。特に翻訳パイプライン（3層圧縮、スライディングウィンドウ、UtteranceBuffer）の設計は独創的かつ実用的。

ただし、**最も緊急な問題はVercel上でのWebSocket非対応**である。これはアーキテクチャ図、通信フロー、状態管理設計に波及する根本的な修正が必要。案A（クライアント→Deepgram直接接続 + 翻訳は個別HTTP）が最もシンプルな解決策。

次に重要なのは**著作権リスク**。ディズニーの台本を商用アプリにバンドルすることはプロダクトの存続に関わるため、法的レビューの計画をMVP前に盛り込むべき。

これらの問題はいずれも追記・修正で対応可能であり、コンセプトや技術アーキテクチャを根本から見直す必要はない。
