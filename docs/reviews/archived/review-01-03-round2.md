# Murmur - ドキュメントレビュー報告書（第2回）

> レビュー実施日: 2026-02-16
> 対象: 01-requirements.md / 02-api-research.md / 03-system-design.md（第1回レビュー後の修正版）
> レビュー観点: 第1回レビュー指摘事項の対応状況、新規発見事項
>
> **前回レビュー**: [review.md](./archived/review.md)

---

## 総合評価

| 対象 | 前回 | 今回 | 変化 | 一言 |
|------|------|------|------|------|
| 要件定義書 | B+ | **B+** | → | Critical全対応。ただしテンプレート内容の矛盾と一部Major未対応 |
| API調査レポート | B+ | **B+** | → | 追加調査充実。Section 1の数値と新Section 5の不整合あり |
| 設計書 | B | **B+** | ↑ | アーキテクチャ修正は的確。エンドポイント配置とセッション管理が新規課題 |

---

## 第1回 Critical 対応状況

| # | 指摘 | 対応状況 | 詳細 |
|---|------|----------|------|
| C1 | Vercel WebSocket非対応 | ✅ 完了 | クライアント→Deepgram直接WebSocket + POST→SSE翻訳に修正。一時トークンAPI追加 |
| C2 | Vercel タイムアウト制約 | ✅ 完了 | utterance毎の独立HTTPリクエスト（2-3秒）で10秒制限内に収まる設計に変更 |
| C3 | Context Cache最小トークン | ✅ 完了 | Layer 2（~2K tokens）をキャッシュ対象に含め、合計~2,150トークンで1,024最小要件を充足 |
| C4 | 著作権リスク | ⚠️ 部分対応 | リスクを「高」に引き上げ、対策記載あり。ただし **矛盾あり**（後述） |
| C5 | ネットワーク要件 | ✅ 完了 | 非機能要件にネットワークセクション追加。Opusコーデック、32kbps最低帯域、オフラインUI |
| C6 | 音声キャプチャ制約 | ✅ 完了 | Wake Lock API、バッテリー消費、外部マイク推奨を記載 |

---

## 新規発見事項

### Critical（新規）

#### NC1. コンテキスト調査エンドポイントの配置矛盾 [設計]

設計書内で矛盾が存在する：

- **Section 3.3 API仕様**: `/api/research` がNext.js APIルートとして定義
- **Section 1.2 ホスティング制約**: 「長時間処理はSupabase Edge Functionsに委譲」と記載
- **ディレクトリ構造**: `api/research/` がNext.jsルート配下に配置

Vercel Hobbyの10秒タイムアウトでは、Tavily + Firecrawl + LLM要約を含むコンテキスト調査は確実にタイムアウトする。

**→ 対応案**: コンテキスト調査は完全にSupabase Edge Functionsに移管し、Next.js APIは進捗ポーリング用の薄いラッパーのみにする。

#### NC2. セッションライフサイクル管理の欠如 [設計]

セッションの作成・終了に関するAPIエンドポイントが定義されていない：

- セッション作成API（`POST /api/sessions`）がない
- セッション終了API（`PATCH /api/sessions/:id`）がない
- Supabaseへのセッション保存はクライアントから直接RPC？API経由？が不明
- セッション状態遷移（created → active → completed → archived）の定義なし

**→ 対応案**: セッションCRUD APIの設計追加、状態遷移図の作成。

### Major（新規）

#### NM1. テンプレート内容の矛盾 [要件]

requirements.md内で相反する記述がある：

- Section 4.1: 「台本が**公開されている**コンテンツはプリセットテンプレートとしてアプリに同梱」
- リスク表: 「プリセットテンプレートは**『用語集+概要』に限定**し台本全文は含めない」

テンプレートに含めるコンテンツの範囲が未確定。法的リスク対策の観点からは後者が正しいが、Section 4.1の表現が誤解を招く。

**→ 対応案**: Section 4.1を「台本情報が公開されているコンテンツについて、**用語集・概要・主要フレーズ**をプリセットテンプレートとして提供」に修正。

#### NM2. 音声フォーマットの不整合 [要件 × 設計]

ドキュメント間で音声フォーマットの記述が矛盾：

- requirements.md Section 4.2: 「Deepgram Nova-3を利用してWebSocket経由で音声をテキスト化」（フォーマット未指定）
- design.md AudioCapture仕様: PCM 16bit 16kHz（一部記述）
- design.md Section 9.3: Opusコーデック / audio/webm（帯域節約のため）
- api-research.md Section 4: MediaRecorder → audio/webm

Deepgramは`audio/webm;codecs=opus`と`PCM linear16`の両方をサポートするが、実装方針が不統一。

**→ 対応案**: `audio/webm;codecs=opus`（MediaRecorder出力）に統一。帯域32kbps。設計書内のPCM記述を削除。

#### NM3. 音声データ保存ポリシーの矛盾 [要件 × 設計]

- requirements.md Section 6: 「音声データの**暗号化保存**」
- design.md Section 9.5: 「音声データは**保存しない**。ストリーミングで直接Deepgramに送信」

両立しない要件。音声保存は帯域・ストレージ・プライバシーの観点からコストが大きい。

**→ 対応案**: requirements.mdを修正し「音声データは保存せず、リアルタイムストリーミングのみ」に統一。必要に応じてPhase 4で録音機能を追加する方針は既に記載あり。

#### NM4. 翻訳リクエストの表示順序保証 [設計]（M20未対応）

第1回レビューのM20が未対応。並行POST→SSEリクエストでutterance 4が3より先に返却された場合、字幕が逆転する問題。

**→ 対応案**: クライアント側でシーケンス番号を管理し、TranslationDisplay コンポーネントで順序制御。先に到着した後続翻訳はバッファリングし、前の翻訳完了後に表示。

#### NM5. 利用時間追跡メカニズムの欠如 [設計]（M23未対応）

セッションの開始/終了時刻からの利用時間計算、無料枠の管理、超過時の挙動が未設計。

**→ 対応案**: sessions テーブルの `started_at` / `ended_at` から月間利用時間を集計するRPC関数を設計。

---

## 第1回 Major 対応状況

### 要件定義書

| # | 指摘 | 対応状況 | 備考 |
|---|------|----------|------|
| M1 | ユーザーストーリー | ❌ 未対応 | Phase 2以降で追加検討 |
| M2 | オンボーディング | ❌ 未対応 | Phase 2以降で追加検討 |
| M3 | セッション操作性 | ⚠️ 部分対応 | 録音開始/停止、ティア選択は記載あり。一時停止/再開、動的コンテキスト切替は未対応 |
| M4 | プライバシーポリシー | ⚠️ 部分対応 | design.md Section 9.5にデータ取扱い記載。requirements.mdには未反映 |
| M5 | アクセシビリティ | ❌ 未対応 | |
| M6 | スケーラビリティ | ❌ 未対応 | Deepgram一時トークンの上限（250/日、同時50接続）が暗黙的な制約 |
| M7 | テスト要件 | ❌ 未対応 | |
| M8 | 決済手段 | ❌ 未対応 | MVP前は不要だがPhase 2で必要 |
| M9 | MVPとの不整合 | ⚠️ 部分対応 | 認証がMVPリストにまだ明示されていない。ダークモードはPhase 3のまま |

### API調査レポート

| # | 指摘 | 対応状況 | 備考 |
|---|------|----------|------|
| M10 | AssemblyAI WER | ⚠️ 部分対応 | Section 5に詳細追加（Universal-3 Pro）。**Section 1の比較表はWER 14.5%のまま未修正** |
| M11 | Speechmatics | ✅ 完了 | Section 5に追加（$0.25-0.35/hr、統合STT+翻訳） |
| M12 | Soniox | ✅ 完了 | Section 5に追加（v4 $0.12/hr、8000 tokenコンテキスト） |
| M13 | EN→JP翻訳品質定量比較 | ❌ 未対応 | BLEU/COMET等のスコアなし |
| M14 | コスト試算 | ✅ 完了 | 修正済み（120 req/hr × 730 tok = 88K input tokens、standard $0.58/hr） |
| M15 | WMT24帰属誤り | ❌ 未対応 | **依然としてClaude Sonnet 4.5と記載。正しくはClaude 3.5 Sonnet** |
| M16 | Web Speech API検証 | ✅ 完了 | iOS Safari連続モードの不具合を確認し、フォールバックから除外 |

**追加指摘:**

- Gemini 3 Flash が翻訳品質比較表に記載されていない（Gemini 2.0 Flashのみ）
- ElevenLabs Scribe のWER欄が「93.5%」のまま（精度とWERの混同）

### 設計書

| # | 指摘 | 対応状況 | 備考 |
|---|------|----------|------|
| M17 | transcripts RLSポリシー | ✅ 完了 | session所有権チェック付きINSERTポリシーに修正 |
| M18 | profiles INSERTポリシー | ✅ 完了 | INSERTポリシー + auth.users トリガーによる自動作成 |
| M19 | セッション状態管理 | ⚠️ 部分対応 | クライアント側（Zustand/hooks）への移行は記載。状態遷移図なし |
| M20 | 翻訳表示順序 | ❌ 未対応 | → NM4として再掲 |
| M21 | コスト試算 | ✅ 完了 | 修正済み |
| M22 | 音声データ保存ポリシー | ⚠️ 部分対応 | Section 9.5に記載あるが、要件定義書との矛盾あり → NM3 |
| M23 | 利用時間追跡 | ❌ 未対応 | → NM5として再掲 |
| M24 | 監視・ロギング | ⚠️ 部分対応 | Vercel Analyticsへの言及あるが、具体的なメトリクス定義なし |

**追加指摘:**

- Section 1.2が2つ存在する（ホスティング選定テーブルとフロントエンド技術）
- ER図で「users」テーブルと記載されているが、実テーブル名は「profiles」
- Deepgram一時トークンのレート制限（250/日）がスケーラビリティに影響する旨の記載なし

---

## 対応優先度マトリクス（更新版）

```
          緊急度 高 ←─────────────────────────→ 緊急度 低
影響度 高  │ NC1 調査エンドポイント配置  │ NM1 テンプレート内容矛盾    │
          │ NC2 セッションライフサイクル │ NM4 翻訳表示順序保証       │
          │ NM3 音声保存ポリシー矛盾   │ M15 WMT24帰属誤り          │
          │ NM2 音声フォーマット不整合  │ M1 ユーザーストーリー      │
          ├─────────────────────────────┼─────────────────────────────┤
影響度 低  │ M10 AssemblyAI WER整合性   │ M5 アクセシビリティ        │
          │ M9 MVPリスト整合性          │ M7 テスト要件              │
          │ NM5 利用時間追跡            │ Section番号重複修正        │
          │ M4 プライバシーポリシー整合 │ ER図テーブル名修正         │
```

---

## 総括

第1回レビューのCritical 6件は全て対応済み。特に**Vercel WebSocket問題の解決**（クライアント直接接続 + POST→SSE）は的確で、$0ホスティングという追加の成果も得られた。Context Caching制約、RLSポリシー修正も適切。

第2回レビューでの主な課題は以下の3点：

1. **ドキュメント間の整合性**: 音声フォーマット（PCM vs Opus）、音声保存ポリシー（暗号化保存 vs 保存しない）、テンプレート内容（台本同梱 vs 用語集限定）など、修正が部分的に適用され矛盾が残存
2. **設計の補完**: セッションライフサイクルAPI、コンテキスト調査エンドポイントの正しい配置、翻訳表示順序制御が未設計
3. **数値データの整合性**: API調査レポートのSection 1とSection 5間でAssemblyAI WERが不一致、WMT24の帰属が未修正

いずれもコア設計の変更は不要で、ドキュメントの整合性修正と補完設計の追加で対応可能。**MVPの実装着手に支障をきたすブロッカーはなく、実装と並行して修正可能なレベル。**
