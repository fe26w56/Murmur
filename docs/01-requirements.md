# Murmur - 要件定義書

## 1. プロダクト概要

**Murmur** は、海外旅行中にディズニーのアトラクション、博物館の展示解説、演劇などの英語音声をリアルタイムで文字起こし・翻訳し、スマートフォンの画面上に表示するWebアプリケーションである。

### コンセプト

「聞き取れなくても、わかる。」

事前にアトラクション名や演劇のURLなどのコンテキスト情報を登録することで、AIが事前調査を行い、音声認識の精度が低い環境（騒音・反響・スピーカー越し）でも、高精度な翻訳を実現する。

---

## 2. 解決する課題

| 課題 | 詳細 |
|------|------|
| 言語の壁 | 海外テーマパーク・博物館・劇場で英語の解説や台詞が理解できない |
| 騒音環境 | アトラクション内の効果音・歓声で音声認識精度が低下する |
| リアルタイム性 | 事後翻訳では体験の臨場感が失われる |
| 既存ツールの限界 | 汎用翻訳アプリは専門用語やコンテンツ固有の文脈を理解しない |

---

## 3. ターゲットユーザー

- 海外ディズニーパーク（WDW、DLR、DLP等）に行く日本人旅行者
- 海外の博物館・美術館を訪れる旅行者
- ブロードウェイ等の英語演劇を観劇する旅行者
- 英語のリスニングに不安がある海外旅行者全般

---

## 4. ユーザーストーリー（MVP）

| # | ユーザーとして | 〜したい | 理由 |
|---|-------------|---------|------|
| US1 | 旅行前のユーザー | プリセットテンプレートからアトラクションを選んでコンテキストを登録したい | 当日すぐに使えるようにしたい |
| US2 | 旅行前のユーザー | 手動でアトラクション名を入力してコンテキストを作成したい | テンプレートにないコンテンツにも対応したい |
| US3 | アトラクション乗車中のユーザー | 録音ボタンを押して英語音声のリアルタイム翻訳を画面で見たい | 英語が聞き取れなくても内容を理解したい |
| US4 | アトラクション乗車中のユーザー | 翻訳ティアを切り替えたい | コストと品質をコンテンツに合わせて調整したい |
| US5 | 体験後のユーザー | セッション履歴から過去の文字起こし・翻訳を見返したい | 旅行の思い出として振り返りたい |
| US6 | 初回ユーザー | Google or メールでログインしたい | すぐに利用を開始したい |

---

## 5. コア機能

### 5.1 事前コンテキスト登録（最大の差別化ポイント）

ユーザーが訪問予定のコンテンツ情報を事前に登録する機能。2つの登録方法を提供する。

**方法1: プリセットテンプレートから選択**

ディズニーの主要アトラクション（WDW 13件 + DLR 13件、計26件）など、公開情報が豊富なコンテンツについて、**用語集・概要・主要フレーズ**をプリセットテンプレートとしてアプリに同梱。ワンタップで利用可能。台本全文は著作権リスクのため含めない（詳細は「9. リスクと対策」参照）。

**方法2: 手動入力 + AI自動調査**

```
入力例:
- アトラクション名: "Haunted Mansion"
- 施設名: "The Metropolitan Museum of Art"
- 演劇URL: "https://www.broadwayshow.com/hamilton"
- 自由テキスト: "Star Warsエリアのキャストとの会話"
```

**AI事前調査の処理フロー:**

1. ユーザーがコンテンツ情報を登録
2. AIがWeb検索・スクレイピングで関連情報を収集
   - アトラクションのスクリプト（台本）・セリフ集
   - 博物館の展示解説テキスト
   - 演劇のあらすじ・登場人物・有名なセリフ
   - 関連する専門用語・固有名詞の辞書
3. 収集した情報を「コンテキストデータ」として構造化・保存
4. リアルタイム翻訳時にコンテキストデータを参照し、翻訳精度を向上

**精度向上の仕組み:**

- 音声認識で「haunted」が「hunted」と誤認識されても、Haunted Mansionのコンテキストから正しく補正
- 専門用語（例: 博物館の "impressionism", "Renaissance"）を事前に辞書化し認識率向上
- 演劇の台本情報をもとに、次に来るセリフを予測し翻訳の遅延を短縮

### 5.2 リアルタイム音声文字起こし

- スマートフォンのマイクから英語音声をキャプチャ
- **Deepgram Nova-3** を利用してWebSocket経由で音声をテキスト化
  - 騒音環境に特化（WER 6.84%）、遅延 <300ms
  - キーターム・プロンプティングでコンテキストの専門用語をブースト
- ストリーミング方式でリアルタイムに処理
- フォールバック: 自動再接続（最大3回）→ 音声認識停止（手動再開）

### 5.3 リアルタイム翻訳・表示

- 文字起こしテキストを日本語にリアルタイム翻訳
- **3段階の翻訳ティア**を選択可能:
  - **lite**: Gemini 2.5 Flash-Lite（案内板・簡単な説明向け、低コスト）
  - **standard**: Gemini 3 Flash（アトラクション・一般翻訳、SimpleQA 68.7%で固有名詞に強い）
  - **premium**: Claude Sonnet 4.5（演劇・文学的翻訳、最高品質）
- 画面上に字幕スタイルで表示（映画の字幕のようなUX）
- 英語原文と日本語訳の同時表示オプション
- スライディングウィンドウ方式で直近3件の翻訳履歴を参照し、一貫性を維持

### 5.4 セッション管理

- 体験ごとにセッションを作成・保存
- 過去のセッション（文字起こし・翻訳ログ）を後から閲覧可能
- 旅行の思い出としてエクスポート可能

---

## 6. 画面構成

### 6.1 ホーム画面

- セッション一覧（過去の記録）
- 「新しいセッション」ボタン
- コンテキスト登録へのリンク

### 6.2 コンテキスト登録画面

- **テンプレート選択タブ**: プリセットテンプレート一覧（パーク別に分類）
  - ワンタップでコンテキストを作成、そのまま利用可能
- **手動作成タブ**:
  - コンテンツ種別の選択（テーマパーク / 博物館 / 演劇 / その他）
  - アトラクション名・施設名・URLの入力フォーム
  - AI調査の実行ボタンと進捗表示
  - 収集されたコンテキストデータのプレビュー・編集
  - 用語集（glossary）の手動追加・編集

### 6.3 ライブ翻訳画面（メイン）

- 字幕表示エリア（画面下部、大きな文字）
- 原文（英語）表示エリア（トグルで表示/非表示）
- コンテキスト選択（どのコンテキストを使うか）
- 翻訳ティア選択（lite / standard / premium）
- 録音開始/停止ボタン
- 設定（文字サイズ、表示モード、言語ペア）

### 6.4 セッション履歴画面

- タイムスタンプ付きの文字起こし・翻訳ログ
- テキスト検索
- エクスポート機能（テキスト / PDF）

---

## 7. 非機能要件

> 技術構成・データモデルの詳細は [設計書 (03-system-design.md)](./03-system-design.md) を参照。

### パフォーマンス

- 音声認識から翻訳表示まで **2秒以内** を目標
- コンテキスト付き翻訳でも **3秒以内**

### ユーザビリティ

- 片手操作で完結するUI
- 暗い環境（劇場内）での視認性を考慮（MVPではOSのダーク/ライトモード設定に追従、Phase 3で手動トグル追加）
- 文字サイズの調整機能

### セキュリティ

- ユーザー認証必須
- 音声データは保存せず、リアルタイムストリーミングのみ（Deepgramへ直接送信後破棄）
- 文字起こし・翻訳テキストはSupabaseに保存（ユーザーが削除するまで保持）
- API キーのサーバーサイド管理

### プライバシー

- 音声データ: クライアントからDeepgramへ直接ストリーミング。サーバー・クライアントに保存しない
- Deepgram側のデータ保持: デフォルトで保持しない設定を使用
- 文字起こし・翻訳テキスト: ユーザーがセッション削除すると完全削除（CASCADE）
- 利用規約・プライバシーポリシーをアプリ内に掲示（MVP時点で簡易版を用意）

### ネットワーク

- 最低上り帯域: 32kbps（audio/webm圧縮時）、推奨128kbps以上
- 海外ローミング環境での動作を考慮（Opusコーデックで帯域圧縮）
- オフライン時はUIに通知し、自動再接続を試行
- 音声データはサーバーを経由せずDeepgramに直接送信（帯域節約）

### 対応環境

- iOS Safari 15+
- Android Chrome 90+
- 画面常時ON維持（Wake Lock API）— 長時間セッション対応
- 外部マイク（ラベリアマイク、Bluetoothイヤホン）の使用推奨

---

## 8. MVP（最小実装）スコープ

### Phase 1: MVP

- [ ] ユーザー認証（Supabase Auth: Google OAuth + メール）
- [ ] リアルタイム音声文字起こし（Deepgram Nova-3）
- [ ] リアルタイム翻訳表示（Gemini 3 Flash、3段階ティア対応）
- [ ] スライディングウィンドウ翻訳（直近3件の履歴で一貫性維持）
- [ ] プリセットテンプレートからのコンテキスト登録（ディズニー26アトラクション）
- [ ] シンプルなコンテキスト手動登録（テキスト入力）
- [ ] コンテキストを翻訳プロンプトに反映（3層圧縮）
- [ ] Deepgramキーワードブースト（コンテキストの専門用語を認識強化）
- [ ] セッション保存・履歴閲覧
- [ ] 簡易プライバシーポリシー・利用規約

### Phase 2: コンテキストAI強化

- [ ] URL入力からのAI自動調査（Tavily + Firecrawl）
- [ ] 専門用語辞書の自動生成
- [ ] コンテキストデータのプレビュー・編集UI
- [ ] 音声認識の誤り補正（コンテキストベース）
- [ ] Gemini Context Caching による翻訳コスト削減

### Phase 3: UX向上

- [ ] PWA対応（ホーム画面追加、オフラインUI）
- [ ] ダークモード
- [ ] セッションエクスポート（PDF）
- [ ] 多言語対応（翻訳先: 日本語以外にも）

### Phase 4: 拡張

- [ ] コンテキストテンプレート共有機能（他ユーザーが作ったコンテキストを利用）
- [ ] Gemini 2.0 Flash Live API による音声→翻訳一体型パイプライン
- [ ] DeepL Voice API 統合（高品質翻訳オプション）
- [ ] 音声の録音・再生機能

---

## 9. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 騒音環境での音声認識精度低下 | 高 | Deepgramキーワードブースト、コンテキストベースのLLM補正、自動再接続 |
| API利用コスト増大 | 中 | 3段階翻訳ティアでコスト調整、コンテキストキャッシュ、3層コンテキスト圧縮 |
| ブラウザのマイクAPI制限 | 中 | HTTPS必須、PWA化で安定動作 |
| 翻訳のレイテンシ | 中 | ストリーミングレスポンス、UtteranceBuffer による発話結合最適化 |
| 著作権（台本データ収集） | **高** | プリセットテンプレートは「用語集+概要」に限定し台本全文は含めない。公開情報のみ収集。利用規約で免責。本番リリース前に著作権の法的レビューを実施 |
| iOSバックグラウンド制限 | 中 | Wake Lock APIで画面常時ON。ロック時は通知で再開を促す |
| バッテリー消費 | 中 | 省電力UI設計、セッション時間の警告表示（1時間超で通知） |
| 翻訳の一貫性（チャンク分割） | 中 | スライディングウィンドウ翻訳で直近3件の履歴を参照 |

---

## 10. 用語集

| 用語 | 意味 |
|------|------|
| コンテキスト | ユーザーが事前登録するコンテンツ情報とAIが収集した関連データの総称 |
| プリセットテンプレート | アプリに同梱された事前調査済みコンテキスト（ディズニーアトラクション等） |
| セッション | 1回の文字起こし・翻訳の記録単位 |
| グロッサリー | コンテキストから生成される専門用語辞書（EN/JP対訳） |
| ライブ翻訳 | リアルタイムで音声→文字起こし→翻訳→表示する一連の処理 |
| 翻訳ティア | 翻訳品質の段階（lite / standard / premium）。用途に応じて選択 |
| スライディングウィンドウ | 直近N件の翻訳履歴をLLMに渡し、一貫性を維持する手法 |
| キーワードブースト | Deepgramに専門用語を事前登録し、音声認識の優先度を上げる機能 |
