# Murmur - 画面設計書

> 対象: Phase 1 MVP
> 参照: [要件定義書](./01-requirements.md) / [設計書](./03-system-design.md) / [実装計画書](./05-implementation-plan.md)

### デザインカンプ

実装時は以下の Pencil デザインファイルを参照し、カラー・タイポグラフィ・レイアウトを忠実に再現すること。

| ファイル | 内容 |
|----------|------|
| [`screen.pen`](../screen.pen) | 全画面デザインカンプ（S1〜S8 + 状態バリエーション） |

**デザイントークン（`screen.pen` 内の変数定義）:**

| トークン | 値 | 用途 |
|----------|-----|------|
| `$primary` | `#6366F1` | プライマリカラー（Indigo） |
| `$primary-light` | `#EEF2FF` | プライマリ薄色背景 |
| `$bg-page` | `#FFFFFF` | ページ背景 |
| `$bg-card` | `#F8F9FA` | カード背景 |
| `$bg-input` | `#F1F5F9` | インプット背景 |
| `$bg-dark` | `#0F172A` | ダークモード背景（ライブ翻訳録音中） |
| `$text-primary` | `#0F172A` | メインテキスト |
| `$text-secondary` | `#64748B` | セカンダリテキスト |
| `$text-muted` | `#94A3B8` | ミュートテキスト |
| `$border` | `#E2E8F0` | ボーダー |
| `$destructive` | `#EF4444` | 破壊的アクション |
| `$success` | `#22C55E` | 成功 |
| `$warning` | `#F59E0B` | 警告 |

**フォント:**

| 用途 | フォント | ウェイト |
|------|----------|----------|
| 見出し（アプリ名・セクションタイトル） | Bricolage Grotesque | 700 |
| 本文・ラベル・ボタン | DM Sans | 400-600 |

**共通コンポーネント仕様:**

| コンポーネント | 角丸 | 高さ | 備考 |
|---------------|------|------|------|
| ボタン（プライマリ） | 12px | 52px | `$primary` 背景、白テキスト |
| インプットフィールド | 10px | 48px | `$bg-input` 背景 |
| カード | 12px | auto | `$bg-card` 背景 |
| セグメントコントロール | 22px（外）/ 18px（内） | 44px | `$bg-input` 背景、アクティブは白 |
| BottomNav | — | 64px | 3タブ（ホーム / コンテキスト / 翻訳） |

---

## 1. 画面一覧と遷移図

### 1.1 画面一覧

| #   | 画面名               | パス               | 認証  | 概要                                      |
| --- | ----------------- | ---------------- | --- | --------------------------------------- |
| S1  | ログイン画面            | `/auth/login`    | 不要  | Google OAuth / メール認証                    |
| S1a | OAuthコールバック画面     | `/auth/callback` | —   | `route.ts` でサーバーサイドのコード交換・Cookie確立・リダイレクト。`page.tsx` でローディング/エラー表示 |
| S2  | ホーム画面             | `/`              | 必須  | セッション一覧、月間利用時間、クイックアクション                |
| S3  | コンテキスト一覧画面        | `/contexts`      | 必須  | 登録済みコンテキスト一覧                            |
| S4  | コンテキスト新規作成画面      | `/contexts/new`  | 必須  | テンプレート選択 / 手動作成（タブ切替）                   |
| S5  | コンテキスト詳細・編集画面     | `/contexts/[id]` | 必須  | コンテキスト情報の閲覧・編集・用語集管理                    |
| S6  | ライブ翻訳画面           | `/live`          | 必須  | リアルタイム音声文字起こし・翻訳・字幕表示                   |
| S7  | セッション履歴詳細画面       | `/sessions/[id]` | 必須  | 過去セッションの文字起こし・翻訳ログ閲覧                    |
| S8  | プライバシーポリシー・利用規約画面 | `/legal`         | 不要  | 法的文書の掲示                                 |

### 1.2 画面遷移図

```
                    ┌──────────────┐
                    │  S1: ログイン  │
                    │  /auth/login │
                    └──────┬───────┘
                           │ 認証成功
                           ▼
┌──────────────────────────────────────────────────────┐
│                BottomNav（3タブ）                       │
│                                                       │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ S2: ホーム    │  │ S3: コンテキスト│  │ S6: ライブ翻訳│ │
│  │ /            │  │ /contexts    │  │ /live        │ │
│  └──┬───┬──────┘  └──┬───┬──────┘  └──────────────┘ │
│     │   │            │   │                            │
│     │   │            │   └──► S4: 新規作成             │
│     │   │            │       /contexts/new            │
│     │   │            │                                │
│     │   │            └──► S5: 詳細・編集               │
│     │   │                /contexts/[id]               │
│     │   │                    │                        │
│     │   │                    └──► S6: ライブ翻訳        │
│     │   │                    （このコンテキストで翻訳開始）│
│     │   │                                             │
│     │   └──► S7: セッション履歴詳細                      │
│     │       /sessions/[id]                            │
│     │                                                 │
│     └──► S6: ライブ翻訳（「新しいセッション」から遷移）     │
│                                                       │
└──────────────────────────────────────────────────────┘

※ S8: /legal はフッターリンクから全画面でアクセス可能
```

---

## 2. 共通レイアウト

### 2.1 レイアウト構造

```
┌────────────────────────────────────┐
│  Header（56px固定）                  │
│  ┌──────┐                   ┌────┐ │
│  │ Logo │    Murmur         │ ☰  │ │
│  └──────┘                   └────┘ │
├────────────────────────────────────┤
│                                    │
│  メインコンテンツ                     │
│  （スクロール可能エリア）               │
│  padding: 16px                     │
│                                    │
│                                    │
│                                    │
├────────────────────────────────────┤
│  BottomNav（64px固定）               │
│  ┌──────┐  ┌──────────┐  ┌─────┐  │
│  │ ホーム │  │コンテキスト │  │ 翻訳 │  │
│  │  🏠   │  │    📋     │  │  🎤  │  │
│  └──────┘  └──────────┘  └─────┘  │
└────────────────────────────────────┘
```

### 2.2 Header（`components/layout/Header.tsx`）

| 要素                | 位置  | 動作            |
| ----------------- | --- | ------------- |
| ロゴ + アプリ名「Murmur」 | 左寄せ | タップでホーム画面へ遷移  |
| ユーザーメニューアイコン      | 右寄せ | タップでドロップダウン表示 |

**ユーザーメニュー（ドロップダウン）:**

```
┌──────────────────┐
│ user@example.com │  ← メールアドレスまたは表示名
├──────────────────┤
│ ログアウト        │
│ プライバシーポリシー│
└──────────────────┘
```

### 2.3 BottomNav（`components/layout/BottomNav.tsx`）

| タブ | アイコン | ラベル | 遷移先 |
|------|---------|--------|--------|
| ホーム | Home | ホーム | `/` |
| コンテキスト | FileText | コンテキスト | `/contexts` |
| ライブ翻訳 | Mic | 翻訳 | `/live` |

- アクティブタブはプライマリカラーでハイライト
- ライブ翻訳画面では BottomNav を非表示（字幕表示エリアを最大化するため）

### 2.4 テーマ・カラー

- OSのダーク/ライトモード設定に自動追従（`prefers-color-scheme`）
- shadcn/ui のデフォルトテーマを基本とし、プライマリカラーのみカスタマイズ
- ダークモード: 暗い背景に明るい文字（劇場内での視認性確保）
- ライトモード: 明るい背景に暗い文字（屋外での視認性確保）

### 2.5 レスポンシブ対応

- モバイルファースト設計（主にスマートフォンで使用）
- ブレークポイント: 基本は `max-w-lg`（512px）を中央配置
- 片手操作を前提としたUI配置（操作ボタンは画面下部に集約）

---

## 3. 各画面詳細

### S1: ログイン画面（`/auth/login`）

**対応ユーザーストーリー**: US6

```
┌────────────────────────────────────┐
│                                    │
│                                    │
│           Murmur                   │
│   「聞き取れなくても、わかる。」       │
│                                    │
│  ┌────────────────────────────────┐│
│  │  G  Googleでログイン             ││
│  └────────────────────────────────┘│
│                                    │
│  ──────── または ────────           │
│                                    │
│  メールアドレス                      │
│  ┌────────────────────────────────┐│
│  │ email@example.com              ││
│  └────────────────────────────────┘│
│  パスワード                         │
│  ┌────────────────────────────────┐│
│  │ ••••••••                       ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │         ログイン                 ││
│  └────────────────────────────────┘│
│                                    │
│  アカウントをお持ちでない方は          │
│  こちらから新規登録                   │
│                                    │
│  プライバシーポリシー | 利用規約       │
│                                    │
└────────────────────────────────────┘
```

**要素詳細:**

| 要素 | 仕様 |
|------|------|
| ロゴ + キャッチコピー | 画面中央上部。アプリ名と「聞き取れなくても、わかる。」を表示 |
| Google ログインボタン | Supabase Auth の `signInWithOAuth({ provider: 'google' })` を呼出 |
| メール / パスワードフォーム | Supabase Auth の `signInWithPassword()` を呼出 |
| 新規登録リンク | 同一ページ内でフォームを「ログイン」⇄「新規登録」に切替（`signUp()` を呼出） |
| 法的リンク | `/legal` へ遷移 |

**状態:**

| 状態 | 表示 |
|------|------|
| 初期表示 | ログインフォーム |
| ローディング | ボタンをスピナーに変更、フォーム無効化 |
| エラー（認証失敗） | フォーム上部に赤色エラーメッセージ（「メールアドレスまたはパスワードが正しくありません」） |
| エラー（ネットワーク） | 「ネットワークエラーが発生しました。再度お試しください」 |
| 新規登録モード | ボタンラベル「新規登録」に変更、パスワード確認フィールドが追加表示（下記参照） |
| メール確認待ち | 「確認メールを送信しました。メール内のリンクをクリックしてアカウントを有効化してください。」 |

**新規登録モード（フォーム差分）:**

```
│  パスワード                         │
│  ┌────────────────────────────────┐│
│  │ ••••••••                       ││
│  └────────────────────────────────┘│
│  パスワード（確認）                  │
│  ┌────────────────────────────────┐│
│  │ ••••••••                       ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │         新規登録                 ││
│  └────────────────────────────────┘│
│                                    │
│  すでにアカウントをお持ちの方は       │
│  こちらからログイン                   │
```

> パスワードリセットフローはMVP後に実装する。

---

### S1a: OAuthコールバック画面（`/auth/callback`）

**実装責務の分離:**

| ファイル | 責務 |
|----------|------|
| `app/auth/callback/route.ts` | サーバーサイドでOAuth認証コードを受け取り、Supabase の `exchangeCodeForSession` を実行してセッションCookieを確立する。成功時は `/` にリダイレクト、失敗時は `/auth/callback?error=auth_failed` にリダイレクト |
| `app/auth/callback/page.tsx` | ローディング表示（スピナー + 「認証中...」）。URLに `error` パラメータがある場合はエラー表示（「認証に失敗しました」+ ログイン画面への戻りリンク）。通常フローでは `route.ts` が即座にリダイレクトするため、この画面が長時間表示されることはない |

> **なぜ `route.ts` でコード交換するか**: `middleware.ts` がリクエストごとにサーバーサイドでセッションCookieを検証する認証アーキテクチャのため、コード交換もサーバーサイド（`route.ts`）で行い、レスポンスのSet-CookieヘッダーでセッションCookieを確立する必要がある。クライアントサイド（`page.tsx`）でのコード交換では、`middleware.ts` がCookieを認識できるタイミングにずれが生じ、リダイレクトループが発生するリスクがある。

```
┌────────────────────────────────────┐
│                                    │
│                                    │
│                                    │
│           (スピナー)                │
│           認証中...                 │
│                                    │
│                                    │
│                                    │
└────────────────────────────────────┘
```

| 状態 | 表示 |
|------|------|
| 認証処理中 | スピナー + 「認証中...」 |
| 認証成功 | `/` にリダイレクト |
| 認証失敗 | 「認証に失敗しました。再度お試しください。」+ ログイン画面への戻りリンク |

---

### S2: ホーム画面（`/`）

**対応ユーザーストーリー**: US5

```
┌────────────────────────────────────┐
│  Header                            │
├────────────────────────────────────┤
│                                    │
│  ┌────────────────────────────────┐│
│  │ 月間利用時間                     ││
│  │ ████████░░░░░  32分 / 60分      ││
│  └────────────────────────────────┘│
│                                    │
│  ┌────────────────────────────────┐│
│  │  🎤  新しいセッションを開始       ││
│  └────────────────────────────────┘│
│                                    │
│  最近のセッション                    │
│                                    │
│  ┌────────────────────────────────┐│
│  │ Haunted Mansion         14:32  ││
│  │ standard • 8分                  ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │ Pirates of the Caribbean 13:05 ││
│  │ lite • 12分                     ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │ Space Mountain           12:20 ││
│  │ standard • 5分                  ││
│  └────────────────────────────────┘│
│                                    │
│  セッションがありません              │
│  ↑ セッション0件時のみ表示           │
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**要素詳細:**

| 要素 | 仕様 |
|------|------|
| 月間利用時間カード | `get_monthly_usage` RPCの結果を画面表示時に取得。プログレスバー + テキスト。残量10分未満で黄色警告、残量ゼロで赤色。表示単位: 60分未満は「○分」、60分以上は「○時間○分」形式 |
| 「新しいセッションを開始」ボタン | プライマリカラー。タップで `/live` に遷移。残量ゼロ時は無効化し「今月の利用時間の上限に達しました。来月1日にリセットされます。」を表示 |
| セッション一覧 | `GET /api/sessions?limit=20&offset=0` で取得。`created_at` 降順。最新20件を表示。20件以上ある場合は「もっと見る」ボタンで `offset` を増加させて追加読み込み（offset-based pagination）。各カードはタップで `/sessions/[id]` に遷移 |
| 空状態 | セッションが0件の場合、イラスト + 「セッションがありません。新しいセッションを開始しましょう。」を表示 |

**SessionCard コンポーネント（`components/sessions/SessionCard.tsx`）:**

```
┌────────────────────────────────────┐
│ Haunted Mansion             14:32  │
│ standard • 8分                      │
└────────────────────────────────────┘
```

| 要素 | データソース |
|------|------------|
| タイトル（左上） | `session.title`（コンテキスト名 + 日時から自動生成） |
| 時刻（右上） | `session.started_at` をHH:mm形式で表示 |
| ティアバッジ + 時間（左下） | `session.translation_tier` + `ended_at - started_at` の分数 |

---

### S3: コンテキスト一覧画面（`/contexts`）

**対応ユーザーストーリー**: US1, US2

```
┌────────────────────────────────────┐
│  Header                            │
├────────────────────────────────────┤
│                                    │
│  マイコンテキスト                    │
│                                    │
│  ┌────────────────────────────────┐│
│  │ Haunted Mansion                ││
│  │ 🏰 テーマパーク • 用語12件       ││
│  │ WDW - Magic Kingdom            ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │ Hamilton                       ││
│  │ 🎭 演劇 • 用語5件               ││
│  │ 手動作成                        ││
│  └────────────────────────────────┘│
│  ┌────────────────────────────────┐│
│  │ The Met - Egypt Wing           ││
│  │ 🏛️ 博物館 • 用語8件             ││
│  │ 手動作成                        ││
│  └────────────────────────────────┘│
│                                    │
│  コンテキストがありません             │
│  ↑ 0件時のみ表示                    │
│                                    │
│             ┌────┐                 │
│             │ ＋ │  ← FAB          │
│             └────┘                 │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**要素詳細:**

| 要素 | 仕様 |
|------|------|
| コンテキスト一覧 | `GET /api/contexts?limit=20&offset=0` で取得。`created_at` 降順。最新20件を表示、20件以上で「もっと見る」ボタン（offset-based pagination） |
| FAB（Floating Action Button） | 右下に配置。タップで `/contexts/new` に遷移 |
| 空状態 | 0件時にイラスト + 「コンテキストを作成して、翻訳精度を向上させましょう。」 |

**ContextCard コンポーネント（`components/contexts/ContextCard.tsx`）:**

```
┌────────────────────────────────────┐
│ Haunted Mansion                    │
│ 🏰 テーマパーク • 用語12件           │
│ WDW - Magic Kingdom               │
└────────────────────────────────────┘
```

| 要素 | データソース |
|------|------------|
| タイトル | `context.title` |
| 種別アイコン + ラベル | `context.type`（theme_park: 🏰, museum: 🏛️, theater: 🎭, other: 📄） |
| 用語数 | `context.glossary.length` |
| 出典 | テンプレートの場合: テンプレートのpark名。手動の場合:「手動作成」 |

---

### S4: コンテキスト新規作成画面（`/contexts/new`）

**対応ユーザーストーリー**: US1, US2

#### タブ1: テンプレートから選択

```
┌────────────────────────────────────┐
│  ← 戻る     コンテキスト作成          │
├────────────────────────────────────┤
│                                    │
│  [テンプレート]  [手動作成]  ← タブ    │
│  ─────────────                     │
│                                    │
│  ┌────────────────────────────────┐│
│  │ 🔍 テンプレートを検索...          ││
│  └────────────────────────────────┘│
│                                    │
│  WDW - Magic Kingdom               │
│                                    │
│  ┌─────────┐ ┌─────────┐          │
│  │ Haunted │ │ Pirates │          │
│  │ Mansion │ │ of the  │          │
│  │         │ │Caribbean│          │
│  │ 用語12件 │ │ 用語10件 │          │
│  └─────────┘ └─────────┘          │
│  ┌─────────┐ ┌─────────┐          │
│  │ Space   │ │ Jungle  │          │
│  │Mountain │ │ Cruise  │          │
│  │         │ │         │          │
│  │ 用語8件  │ │ 用語15件 │          │
│  └─────────┘ └─────────┘          │
│                                    │
│  WDW - EPCOT                       │
│  ...                               │
│                                    │
│  DLR - Disneyland                  │
│  ...                               │
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**TemplatePicker コンポーネント（`components/contexts/TemplatePicker.tsx`）:**

| 要素 | 仕様 |
|------|------|
| 検索バー | テンプレートの `title` でフィルタリング（クライアントサイド検索） |
| パーク別セクション | `park` フィールドでグルーピング。`sort_order` 昇順でソート |
| テンプレートカード | 2列グリッド表示。タイトル + 用語数 + `description`（1行省略） |
| カードタップ動作 | 確認ダイアログ表示 → `POST /api/templates/[id]/use` → 成功後、作成されたコンテキストの詳細画面 `/contexts/[id]` に遷移（用語集のカスタマイズを促進） |

**テンプレート選択確認ダイアログ:**

```
┌────────────────────────────────────┐
│                                    │
│  「Haunted Mansion」を追加           │
│                                    │
│  999人の幽霊が住むゴシックな屋敷を    │
│  巡るダークライド。ゴーストホストの    │
│  ナレーションが全編を通して案内する。  │
│                                    │
│  • 用語集: 12件                     │
│  • キーワード: 8件                   │
│                                    │
│  ┌──────────┐  ┌────────────────┐  │
│  │ キャンセル │  │ コンテキストに追加│  │
│  └──────────┘  └────────────────┘  │
│                                    │
└────────────────────────────────────┘
```

#### タブ2: 手動作成

```
┌────────────────────────────────────┐
│  ← 戻る     コンテキスト作成          │
├────────────────────────────────────┤
│                                    │
│  [テンプレート]  [手動作成]  ← タブ    │
│                  ─────────         │
│                                    │
│  コンテンツ種別                      │
│  ┌─────────┐┌────┐┌────┐┌─────┐   │
│  │テーマパーク││博物館││演劇 ││その他│   │
│  └─────────┘└────┘└────┘└─────┘   │
│                                    │
│  タイトル *                          │
│  ┌────────────────────────────────┐│
│  │ Haunted Mansion               ││
│  └────────────────────────────────┘│
│                                    │
│  URL（任意）                         │
│  ┌────────────────────────────────┐│
│  │ https://...                    ││
│  └────────────────────────────────┘│
│  ※ Phase 2でAI自動調査に使用        │
│                                    │
│  用語集                              │
│  ┌────────────────────────────────┐│
│  │ EN: Ghost Host                 ││
│  │ JA: ゴーストホスト               ││
│  │                         [追加]  ││
│  ├────────────────────────────────┤│
│  │ Ghost Host → ゴーストホスト  [×] ││
│  │ Doom Buggy → ドゥームバギー  [×] ││
│  └────────────────────────────────┘│
│                                    │
│  ┌────────────────────────────────┐│
│  │         作成する                  ││
│  └────────────────────────────────┘│
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**ContextForm コンポーネント（`components/contexts/ContextForm.tsx`）:**

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|-------------|
| type | セグメントコントロール | 必須 | `theme_park` / `museum` / `theater` / `other` |
| title | テキスト入力 | 必須 | 1〜100文字 |
| source_url | URL入力 | 任意 | URL形式チェック |
| glossary | 用語集エディタ | 任意 | EN/JPペア |

**コンテンツ種別の表示ラベル対応:**

| ENUM値 | 日本語ラベル | アイコン |
|--------|-----------|---------|
| `theme_park` | テーマパーク | 🏰 |
| `museum` | 博物館 | 🏛️ |
| `theater` | 演劇 | 🎭 |
| `other` | その他 | 📄 |

**GlossaryEditor コンポーネント（`components/contexts/GlossaryEditor.tsx`）:**

- EN（英語）/ JA（日本語）のペア入力
- 「追加」ボタンで用語ペアをリストに追加
- 各用語は `×` ボタンで削除
- 最大20件まで追加可能。上限到達時は追加ボタンを無効化し「用語は最大20件まで登録できます」を表示
- キーワード（Deepgramブースト用）は用語集のEN側から自動抽出（UIには非表示）

---

### S5: コンテキスト詳細・編集画面（`/contexts/[id]`）

**対応ユーザーストーリー**: US1, US2

```
┌────────────────────────────────────┐
│  ← 戻る     コンテキスト詳細          │
├────────────────────────────────────┤
│                                    │
│  Haunted Mansion                   │
│  🏰 テーマパーク                     │
│  作成日: 2026-02-15                 │
│                                    │
│  ─────────────────────────────     │
│                                    │
│  タイトル                           │
│  ┌────────────────────────────────┐│
│  │ Haunted Mansion               ││
│  └────────────────────────────────┘│
│                                    │
│  URL                               │
│  ┌────────────────────────────────┐│
│  │ （未設定）                       ││
│  └────────────────────────────────┘│
│                                    │
│  用語集（12件）                      │
│  ┌────────────────────────────────┐│
│  │ Ghost Host → ゴーストホスト  [×] ││
│  │ Haunted Mansion → ホーンテッド ││
│  │   マンション                [×] ││
│  │ Doom Buggy → ドゥームバギー  [×] ││
│  │ ...                            ││
│  ├────────────────────────────────┤│
│  │ EN:            JA:      [追加] ││
│  └────────────────────────────────┘│
│                                    │
│  ┌────────────────────────────────┐│
│  │         保存する                  ││
│  └────────────────────────────────┘│
│                                    │
│  ┌────────────────────────────────┐│
│  │  🎤 このコンテキストで翻訳開始    ││
│  └────────────────────────────────┘│
│                                    │
│  ┌────────────────────────────────┐│
│  │    このコンテキストを削除          ││
│  └────────────────────────────────┘│
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**要素詳細:**

| 要素 | 仕様 |
|------|------|
| ヘッダー情報 | タイトル、種別アイコン+ラベル、作成日 |
| 編集フォーム | ContextFormと同一コンポーネントを再利用（編集モード） |
| 用語集エディタ | GlossaryEditorを埋め込み。追加・削除が可能 |
| 保存ボタン | `PUT /api/contexts/[id]` を呼出。成功時にトースト通知 |
| 「このコンテキストで翻訳開始」ボタン | `/live?contextId=[id]` に遷移。ライブ翻訳画面でこのコンテキストが事前選択される |
| 削除ボタン | 赤文字テキストボタン。確認ダイアログ表示後に `DELETE /api/contexts/[id]` |

**削除確認ダイアログ:**

```
┌────────────────────────────────────┐
│                                    │
│  本当に削除しますか？                │
│                                    │
│  「Haunted Mansion」を削除すると     │
│  元に戻せません。                    │
│                                    │
│  ┌──────────┐  ┌──────────┐       │
│  │ キャンセル │  │  削除する  │       │
│  └──────────┘  └──────────┘       │
│                                    │
└────────────────────────────────────┘
```

---

### S6: ライブ翻訳画面（`/live`）

**対応ユーザーストーリー**: US3, US4

> **注意**: この画面ではBottomNavを非表示にし、全画面を翻訳表示に使用する。

#### 状態1: セッション開始前

```
┌────────────────────────────────────┐
│  ← 戻る     ライブ翻訳               │
├────────────────────────────────────┤
│                                    │
│  コンテキスト                        │
│  ┌────────────────────────────────┐│
│  │ Haunted Mansion          ▼     ││
│  └────────────────────────────────┘│
│                                    │
│  翻訳ティア                         │
│  ┌──────┐ ┌──────────┐ ┌───────┐  │
│  │ lite │ │ standard │ │premium│  │
│  └──────┘ └──────────┘ └───────┘  │
│   案内板    アトラクション    演劇     │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│  ┌────────────────────────────────┐│
│  │         ⏺ 録音開始               ││
│  └────────────────────────────────┘│
│                                    │
└────────────────────────────────────┘
```

#### 状態2: 録音中（字幕表示）

```
┌────────────────────────────────────┐
│  ×閉じる  Haunted Mansion   ⚙設定  │
├────────────────────────────────────┤
│                                    │
│  ┌ 中間文字起こし（半透明）─────────┐ │
│  │ Welcome foolish mortals to...  │ │
│  └────────────────────────────────┘ │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
│ ┌──────────────────────────────────┐│
│ │ ← 前の翻訳（フェードアウト中）      ││
│ │ 999人の幽霊がいるが              ││
│ │ あと1人分の余裕がある              ││
│ ├──────────────────────────────────┤│
│ │ ← 原文（トグルON時のみ表示）       ││
│ │ Welcome, foolish mortals        ││
│ ├──────────────────────────────────┤│
│ │ 愚かなる人間どもよ、               ││
│ │ ホーンテッドマンションへようこそ      ││
│ └──────────────────────────────────┘│
│                                    │
│         ⏹ 録音停止                   │
│     ● REC  00:03:42                │
│                                    │
└────────────────────────────────────┘
```

**要素詳細:**

| 要素 | コンポーネント | 仕様 |
|------|-------------|------|
| コンテキストセレクタ | `ContextSelector.tsx` | ドロップダウン。`GET /api/contexts` から取得。先頭に「フリーセッション（コンテキストなし）」を表示 |
| 翻訳ティア選択 | `LiveControls.tsx` | セグメントコントロール。lite / standard / premium。各ティアの下に用途サブテキスト |
| 録音開始ボタン | `LiveControls.tsx` | タップで `POST /api/sessions` → Deepgram接続 → MediaRecorder開始 |
| ヘッダー（録音中） | — | 「×閉じる」（左）、コンテキスト名（中央、コンテキスト未選択時は「フリーセッション」）、「⚙設定」（右） |
| 中間文字起こし | `TranscriptLog.tsx` | Deepgramの `is_final=false` テキストを半透明で表示（画面上部） |
| 字幕表示エリア | `SubtitleDisplay.tsx` | 画面下部30%。最新翻訳を最前面、古い翻訳をフェードアウト |
| 原文表示 | `SubtitleDisplay.tsx` | 設定でON/OFF切替。字幕の上に小さめフォントで原文を表示 |
| 録音停止ボタン | `LiveControls.tsx` | タップで WebSocket切断 → `PATCH /api/sessions/[id]` |
| 録音インジケータ | — | 赤い ● アイコン + 「REC」 + 経過時間（MM:SS形式） |

**SubtitleDisplay 表示仕様:**

| 項目 | 仕様 |
|------|------|
| 表示位置 | 画面下部30%のエリア |
| 最大表示行数 | 3行（超過分は自動スクロール） |
| フォントサイズ | 設定に応じて small(16px) / medium(20px) / large(24px) |
| ストリーミング表示 | SSEで受信した文字を1文字ずつ表示（タイプライター効果） |
| 古い翻訳 | opacity 0.5 → 0.3 とフェードアウト |
| ダークモード時 | 半透明黒背景（`bg-black/70`）+ 白文字 |
| ライトモード時 | 半透明白背景（`bg-white/70`）+ 黒文字 |
| sequenceNumber | 翻訳結果を `sequenceNumber` 順にソートして表示。並行SSEリクエストの順序を保証 |

**AudioCapture コンポーネント（`components/live/AudioCapture.tsx`）:**

| 項目 | 仕様 |
|------|------|
| MIMEタイプ | `audio/webm;codecs=opus` を優先。iOS Safari非対応時は `audio/mp4` にフォールバック |
| 音量インジケータ | 録音ボタン横に音量レベルバーを表示（AudioContext analyserNode で取得） |
| 音声なし検知 | 5秒以上音量が閾値未満の場合、「音声が検出されません。マイクを確認してください」を表示 |

**暗環境（劇場内）での配慮:**

- ライブ翻訳画面（録音中）ではヘッダー・コントロールエリアも暗めの配色を使用
- ダークモード使用を推奨するガイダンスを初回利用時に表示（「劇場内ではダークモードの使用をお勧めします」）
- SubtitleDisplay以外の要素もダークモード時は低コントラストで表示し、周囲への光漏れを最小化

**設定ドロワー（⚙アイコンタップで表示）:**

```
┌────────────────────────────────────┐
│  設定                    [× 閉じる] │
├────────────────────────────────────┤
│                                    │
│  文字サイズ                         │
│  [小] [中] [大]                     │
│                                    │
│  原文を表示                         │
│  [OFF ─── ● ON]                    │
│                                    │
│  翻訳ティア                         │
│  [lite] [standard] [premium]       │
│                                    │
└────────────────────────────────────┘
```

| 設定項目 | 型 | デフォルト値 | 保存先 |
|---------|-----|-----------|--------|
| fontSize | `'small' \| 'medium' \| 'large'` | `'medium'` | `settingsStore`（localStorage） |
| showOriginal | boolean | `false` | `settingsStore`（localStorage） |
| translationTier | `'lite' \| 'standard' \| 'premium'` | `'standard'` | `liveStore`（セッション中のみ） |

> `settingsStore.defaultTier` はセッション開始前の初期選択値として使用。録音中のティア変更は `liveStore` で管理し、次のutteranceから適用される。セッションの `translation_tier` には最後に使用されたティアが記録される。

#### 録音中の「×閉じる」確認ダイアログ

```
┌────────────────────────────────────┐
│                                    │
│  セッションを終了しますか？           │
│                                    │
│  録音中のデータは保存されます。       │
│                                    │
│  ┌──────────┐  ┌────────────────┐  │
│  │ キャンセル │  │ 保存して終了    │  │
│  └──────────┘  └────────────────┘  │
│                                    │
└────────────────────────────────────┘
```

- 「保存して終了」: WebSocket切断 → `PATCH /api/sessions/[id]`（ended_at確定） → ホーム画面遷移
- 「キャンセル」: ダイアログを閉じて録音を継続

#### 状態遷移

```
[セッション開始前]
    │ 録音開始ボタンタップ
    ▼
[マイク権限リクエスト]
    │ 許可
    ▼
[セッション作成中] ← ローディング表示
    │ POST /api/sessions 成功
    ▼
[Deepgram接続中] ← 「接続中...」表示
    │ WebSocket open
    ▼
[録音中] ← 字幕表示、REC表示
    │ 録音停止ボタンタップ
    ▼
[セッション完了] ← 「セッションを保存しました」トースト → ホーム画面に遷移
```

**エラー状態:**

| エラー | 表示 |
|--------|------|
| マイク権限拒否 | ダイアログ:「マイクの使用を許可してください。設定アプリから変更できます。」 |
| Deepgram接続失敗 | 画面上部にバナー:「接続に失敗しました。再接続中... (1/3)」 |
| Deepgram再接続失敗（3回） | ダイアログ:「音声認識に接続できません。ネットワーク接続を確認してください。」+「再試行」ボタン |
| 翻訳APIエラー | 字幕エリアに原文のみ表示。フォールバックティアに自動切替 |
| ネットワーク断 | 画面上部にバナー:「オフラインです。ネットワーク接続を確認してください。」 |
| 利用時間残り5分 | 画面上部にバナー（黄色）:「残り利用時間があと5分です」 |
| 利用時間上限到達 | 自動で録音停止 → セッション保存 → 「今月の利用時間の上限に達しました。セッションを保存しました。」トースト → ホーム画面遷移 |

---

### S7: セッション履歴詳細画面（`/sessions/[id]`）

**対応ユーザーストーリー**: US5

```
┌────────────────────────────────────┐
│  ← 戻る    セッション詳細             │
├────────────────────────────────────┤
│                                    │
│  Haunted Mansion                   │
│  2026-02-15 14:32 〜 14:40（8分）    │
│  standard ティア                    │
│                                    │
│  原文を表示  [OFF ─── ● ON]        │
│                                    │
│  ─────────────────────────────     │
│                                    │
│  14:32:05                          │
│  Welcome, foolish mortals,         │
│  to the Haunted Mansion.           │
│  愚かなる人間どもよ、                │
│  ホーンテッドマンションへようこそ。    │
│                                    │
│  14:32:18                          │
│  I am your host,                   │
│  your Ghost Host.                  │
│  私はあなたの案内人、                │
│  ゴーストホストです。                │
│                                    │
│  14:32:35                          │
│  Our tour begins here              │
│  in this gallery.                  │
│  ツアーはこのギャラリーから           │
│  始まります。                       │
│                                    │
│  ... (スクロール)                    │
│                                    │
│  ─────────────────────────────     │
│                                    │
│  ┌────────────────────────────────┐│
│  │    このセッションを削除           ││
│  └────────────────────────────────┘│
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

**TranscriptViewer コンポーネント（`components/sessions/TranscriptViewer.tsx`）:**

| 要素 | 仕様 |
|------|------|
| セッション情報ヘッダー | タイトル、日時（開始〜終了+所要時間）、ティア。フォントサイズはshadcn/uiデフォルトに従う |
| トランスクリプト一覧 | `transcripts` テーブルから `timestamp_ms` 昇順で取得 |
| 各エントリ | タイムスタンプ（HH:mm:ss）+ 原文（英語、グレー文字）+ 翻訳文（日本語、黒/白文字） |
| 原文表示切替 | トグルスイッチ。`settingsStore.showOriginal` を参照。OFFの場合、原文を非表示にし翻訳文のみ表示 |
| 削除ボタン | 赤文字テキストボタン。確認ダイアログ表示後に `DELETE /api/sessions/[id]`。削除成功後ホーム画面に遷移 |

---

### S8: プライバシーポリシー・利用規約画面（`/legal`）

```
┌────────────────────────────────────┐
│  ← 戻る     法的情報                 │
├────────────────────────────────────┤
│                                    │
│  [プライバシーポリシー] [利用規約]     │
│  ─────────────────────             │
│                                    │
│  プライバシーポリシー                 │
│                                    │
│  最終更新日: 2026-XX-XX             │
│                                    │
│  1. 収集する情報                     │
│  本アプリは以下の情報を収集します:    │
│  - メールアドレス（認証用）           │
│  - 音声データ（リアルタイム処理のみ、│
│    保存しません）                    │
│  - 文字起こし・翻訳テキスト           │
│    （セッション履歴として保存）       │
│                                    │
│  2. 音声データの取り扱い             │
│  ...                               │
│                                    │
│  3. 第三者サービスへのデータ送信      │
│  ...                               │
│                                    │
├────────────────────────────────────┤
│  BottomNav                         │
└────────────────────────────────────┘
```

| 要素 | 仕様 |
|------|------|
| タブ切替 | 「プライバシーポリシー」「利用規約」の2タブ |
| コンテンツ | マークダウン形式の法的文書をレンダリング |
| 認証 | 不要（ログイン画面からもアクセス可能） |

---

## 4. コンポーネント一覧

### 4.1 レイアウトコンポーネント

| コンポーネント | ファイル | 用途 |
|-------------|---------|------|
| Header | `components/layout/Header.tsx` | 全画面共通ヘッダー |
| BottomNav | `components/layout/BottomNav.tsx` | 全画面共通ナビゲーション（ライブ翻訳画面では非表示） |
| AuthGuard | `components/layout/AuthGuard.tsx` | 未認証ユーザーのリダイレクト（`middleware.ts` によるサーバーサイド認証チェックと連携） |

### 4.2 ライブ翻訳コンポーネント

| コンポーネント | ファイル | 用途 |
|-------------|---------|------|
| SubtitleDisplay | `components/live/SubtitleDisplay.tsx` | 字幕表示（メインエリア） |
| AudioCapture | `components/live/AudioCapture.tsx` | マイク入力制御・音量インジケータ |
| TranscriptLog | `components/live/TranscriptLog.tsx` | 中間文字起こし表示 |
| LiveControls | `components/live/LiveControls.tsx` | 録音開始/停止、ティア切替 |
| ContextSelector | `components/live/ContextSelector.tsx` | ライブ翻訳用コンテキスト選択 |
| NetworkStatus | `components/live/NetworkStatus.tsx` | ネットワーク状態通知バナー |

### 4.3 コンテキストコンポーネント

| コンポーネント | ファイル | 用途 |
|-------------|---------|------|
| TemplatePicker | `components/contexts/TemplatePicker.tsx` | テンプレート一覧（パーク別、検索付き） |
| ContextForm | `components/contexts/ContextForm.tsx` | コンテキスト作成・編集フォーム |
| ContextCard | `components/contexts/ContextCard.tsx` | コンテキスト一覧カード |
| GlossaryEditor | `components/contexts/GlossaryEditor.tsx` | 用語集の追加・編集・削除（最大20件） |
| ResearchProgress | `components/contexts/ResearchProgress.tsx` | 調査進捗表示 **（Phase 2で実装）** |

### 4.4 セッションコンポーネント

| コンポーネント | ファイル | 用途 |
|-------------|---------|------|
| SessionCard | `components/sessions/SessionCard.tsx` | セッション一覧カード |
| TranscriptViewer | `components/sessions/TranscriptViewer.tsx` | トランスクリプト閲覧 |

---

## 5. 状態管理

### 5.1 Zustand ストア

| ストア | ファイル | 管理する状態 |
|--------|---------|------------|
| liveStore | `stores/liveStore.ts` | 録音状態、Deepgram接続状態、翻訳結果配列、中間文字起こし、sequenceNumber、現在のティア |
| contextStore | `stores/contextStore.ts` | コンテキスト一覧キャッシュ、選択中コンテキスト |
| settingsStore | `stores/settingsStore.ts` | 文字サイズ、原文表示ON/OFF、デフォルトティア（セッション開始時の初期選択値） |

### 5.2 settingsStore の永続化

```typescript
interface SettingsState {
  fontSize: 'small' | 'medium' | 'large';
  showOriginal: boolean;
  defaultTier: 'lite' | 'standard' | 'premium';
}

// Zustand persist middleware で localStorage に保存
// 画面遷移・リロードしても設定が維持される
```

---

## 6. UI状態パターン

全画面で統一的な状態表示パターンを使用する。

### 6.1 ローディング

- API呼出中はshadcn/ui の `Skeleton` コンポーネントでプレースホルダを表示
- ボタンアクション中はボタン内にスピナーを表示し、ボタンを無効化

### 6.2 空状態

- データが0件の場合、専用の空状態メッセージを表示
- 次のアクションを促すテキストとボタンを含める

### 6.3 エラー状態

- API エラー時は画面上部にトースト通知（shadcn/ui の `Sonner`）
- ネットワークエラーは `NetworkStatus` バナーで常時表示
- フォームバリデーションエラーはフィールド下に赤文字で表示

### 6.4 トースト通知

**共通設定:**

- 表示位置: 画面上部（BottomNavと重ならないように）
- 表示時間: 3秒（自動消去）
- 最大スタック数: 3件

| アクション | メッセージ | 種類 |
|-----------|----------|------|
| コンテキスト作成成功 | 「コンテキストを作成しました」 | success |
| コンテキスト保存成功 | 「変更を保存しました」 | success |
| コンテキスト削除成功 | 「コンテキストを削除しました」 | success |
| セッション完了 | 「セッションを保存しました」 | success |
| セッション削除成功 | 「セッションを削除しました」 | success |
| 利用時間上限到達 | 「今月の利用時間の上限に達しました。セッションを保存しました。」 | warning |
| API エラー | 「エラーが発生しました。再度お試しください」 | error |
